<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<script type="module">
			import * as THREE from 'https://unpkg.com/three/build/three.module.js';
			import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';
			import { EXRLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/EXRLoader.js';
			import { GUI } from 'https://unpkg.com/three@0.128.0/examples/jsm/libs/dat.gui.module.js';

			// ... CameraControl class ...

			const params = {
				envMap: 'EXR',
				roughness: 0.0,
				metalness: 0.0,
				exposure: 1.0,
			};

			// ... rest of your code ...

			// Add environment maps
			const pmremGenerator = new THREE.PMREMGenerator( renderer );
			pmremGenerator.compileEquirectangularShader();

			let exrCubeRenderTarget, pngCubeRenderTarget;
			new EXRLoader().load( 'textures/piz_compressed.exr', function ( texture ) {
				texture.mapping = THREE.EquirectangularReflectionMapping;
				exrCubeRenderTarget = pmremGenerator.fromEquirectangular( texture );
			} );

			new THREE.TextureLoader().load( 'textures/equirectangular.png', function ( texture ) {
						texture.mapping = THREE.EquirectangularReflectionMapping;
				texture.encoding = THREE.sRGBEncoding;
				pngCubeRenderTarget = pmremGenerator.fromEquirectangular( texture );
			} );

			renderer.toneMapping = THREE.ACESFilmicToneMapping;
			renderer.outputEncoding = THREE.sRGBEncoding;

			function updateMaterials() {
				let newEnvMap;
				switch (params.envMap) {
					case "EXR":
						newEnvMap = exrCubeRenderTarget ? exrCubeRenderTarget.texture : null;
						break;
					case "PNG":
						newEnvMap = pngCubeRenderTarget ? pngCubeRenderTarget.texture : null;
						break;
				}

				sphere1.material.roughness = params.roughness;
				sphere1.material.metalness = params.metalness;
				sphere1.material.envMap = newEnvMap;
				sphere1.material.needsUpdate = true;

				sphere2.material.roughness = params.roughness;
				sphere2.material.metalness = params.metalness;
				sphere2.material.envMap = newEnvMap;
				sphere2.material.needsUpdate = true;
			}

			// Set up the GUI
			const gui = new GUI();
			gui.add(params, "envMap", ["EXR", "PNG"]);
			gui.add(params, "roughness", 0, 1, 0.01);
			gui.add(params, "metalness", 0, 1, 0.01);
			gui.add(params, "exposure", 0, 2, 0.01);
			gui.open();

			function animate() {
				requestAnimationFrame(animate);

				updateMaterials();
				renderer.toneMappingExposure = params.exposure;
				renderer.render(scene, camera);
			}

			animate();
		</script>
	</body>
</html>
